# Linux Makefile to build the CPM3.SYS file for Z80-MBC2
# Used for BIOS development and test

# Execute CP/M 2.2 commands on Linux with tnylpo
# https://gitlab.com/gbrein/tnylpo/
# An utility to run CP/M-80 programs under Unix/Linux

TNYLPO =  ./tnylpo -u

GENCPM3 = $(TNYLPO) CPM.COM/GENCPM3
LINK =    $(TNYLPO) CPM.COM/LINK
LOAD =    $(TNYLPO) CPM.COM/LOAD
MAC =     $(TNYLPO) CPM.COM/MAC
PIP =     $(TNYLPO) CPM.COM/PIP
ZSM4 =    $(TNYLPO) CPM.COM/ZSM4


.PHONY:		all
all:		CPMXLDR.COM TESTCPMX.COM


# BIOS test #
# testcpmx.com boots the contained cpmx.sys from a running CP/M
# for CP/M 2.2 use the option [o] b/c cpmx.sys is a binary file
TESTCPMX.COM:	BOOTSYS.BIN CPMX.SYS
		$(PIP) TESTCPMX.COM=BOOTSYS.BIN[o],CPMX.SYS[o]
		cp TESTCPMX.COM TCX.COM
		ls -l BOOTSYS.BIN *CPMX.*


# CPM3.SYS #
# renamed to CPMX.SYS, put it on A: and boot with the modified CPMLDR3.COM
CPMX.SYS:	BNKBIOS3.SPR BNKBDOS3.SPR RESBDOS3.SPR GENCPM.DAT
		$(GENCPM3) AUTO
		mv CPM3.SYS CPMX.SYS

BOOTSYS.BIN:	BOOTSYS.REL
		$(LINK) BOOTSYS.BIN=BOOTSYS.REL

BOOTSYS.REL:	BOOTSYS.MAC
		$(ZSM4) BOOTSYS,BOOTSYS.LIS=BOOTSYS.MAC


# CP/M boot loader #
# put cpmldr3.com as CPMLDR.COM on the root of the SD card
CPMXLDR.COM:	CPMXLDR.REL LDRBIOS.REL
		$(LINK) CPMXLDR=CPMXLDR,LDRBIOS

# check the AUTOEXEC bit and load CPM3.SYS (=0) or CPMX.SYS (=1)
# to have a fallback solution for BIOS tests
CPMXLDR.REL:	CPMXLDR.MAC
		$(ZSM4) CPMXLDR,CPMXLDR.LIS=CPMXLDR

LDRBIOS.REL:	LDRBIOS.MAC
		$(ZSM4) LDRBIOS,LDRBIOS.LIS=LDRBIOS


# BIOS (banked and common part) #
BNKBIOS3.SPR:	BIOSKRNL.REL BOOT.REL CHARIO.REL MOVE.REL SCB.REL VDISK.REL
		$(LINK) BNKBIOS3[B]=BIOSKRNL,BOOT,CHARIO,MOVE,SCB,VDISK

# BIOS components #
BIOSKRNL.REL:	BIOSKRNL.MAC CONFIG.LIB
		$(ZSM4) BIOSKRNL,BIOSKRNL.LIS=BIOSKRNL

BOOT.REL:	BOOT.MAC CONFIG.LIB
		$(ZSM4) BOOT,BOOT.LIS=BOOT /DZPM=1

CHARIO.REL:	CHARIO.MAC CONFIG.LIB
		$(ZSM4) CHARIO,CHARIO.LIS=CHARIO

MOVE.REL:	MOVE.MAC
		$(ZSM4) MOVE,MOVE.LIS=MOVE

SCB.REL:	SCB.MAC
		$(ZSM4) SCB,SCB.LIS=SCB

VDISK.REL:	VDISK.MAC
		$(ZSM4) VDISK,VDISK.LIS=VDISK


Z80TYPE.COM:	Z80TYPE.ASM
		$(TNYLPO) CPM.COM/MAC Z80TYPE
		$(TNYLPO) CPM.COM/LOAD Z80TYPE


.PHONY:	clean
clean:
		rm -f *~ *.LIS *.REL *.BIN *.SYM *.HEX *.PRN

.PHONY:	distclean
distclean:	clean
		rm -f BNKBIOS3.SPR CPMX.SYS CPMXLDR.COM TCX.COM TESTCPMX.COM

